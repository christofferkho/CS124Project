package app.component;

import java.sql.Timestamp;
import java.text.DateFormat;
import java.text.SimpleDateFormat;

import org.springframework.stereotype.Component;

import app.entity.AccessLog;
import app.entity.Student;
import app.entity.Terminal;

@Component
public class LoginCommand extends Command {
	
	private AccessLog login;

	@Override
	public String undo(Exception e) {
		// TODO Auto-generated method stub
		e.printStackTrace();
		accessLogDao.delete(login);
		return "Database error " + e.getMessage();
	}

	@Override
	public String execute() {
		// TODO Auto-generated method stub
		DateFormat date = new SimpleDateFormat("yyyy-MM-dd'T'HH:mm:ss'Z'");
		
		try {
			login = accessLogDao.save(login);
			String ret = date.format(login.getTimeIn());
			login = null;
			return ret;
		} catch (Exception e) {
			// TODO Auto-generated catch block
			return undo(e);
		}
		
	}
	
	public void createAccessLog(int idNo, int terminalPk){
		Student student = studentDao.findByIdNo(idNo);
		Terminal terminal = terminalDao.findById(terminalPk);
		if(student != null){
			Timestamp timestamp = getDate();
			login = new AccessLog(timestamp, student, terminal);
		}
	}

}
